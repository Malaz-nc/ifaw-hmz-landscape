<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hwange-Matetsi-Zambezi Land Use Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Custom Styles (Internal to avoid CSS conflicts) -->
    <style>
        body {
            padding: 0;
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 15px;
        }
        
        /* Map container */
        #landuse-map {
            height: 80vh;
            width: 100%;
            border: 1px solid #ccc;
            position: relative;
        }
        
        /* Loading indicator */
        #loading-indicator {
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            color: #666;
        }
        
        /* Info box styles */
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }
        
        .info h4 {
            margin: 0 0 5px;
            color: #333;
        }
        
        .legend {
            line-height: 18px;
            color: #555;
        }
        
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        
        /* Popup styles */
        .popup-content {
            padding: 10px;
            font-size: 14px;
        }
        
        .popup-content strong {
            color: #333;
        }
        
        /* Error message */
        .error-message {
            color: red;
            text-align: center;
            padding: 20px;
            font-weight: bold;
        }
        
        /* Land use colors */
        .color-box {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        .national-park {
            background-color: #90EE90; /* Light green */
        }
        
        .forest {
            background-color: #006400; /* Dark green */
        }
        
        .safari {
            background-color: #F5DEB3; /* Beige */
        }
        
        .community {
            background-color: #8B4513; /* Dark brown */
        }
        
        .resettlement {
            background-color: #A52A2A; /* Brown */
        }
        
        #map-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        #map-info ul {
            list-style-type: none;
            padding-left: 10px;
        }
        
        #map-info li {
            margin-bottom: 5px;
        }
        
        /* Label styles */
        .landuse-label {
            background: none;
            border: none;
            box-shadow: none;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white;
        }
        
        .place-label {
            background: none;
            border: none;
            box-shadow: none;
            font-size: 10px;
            font-weight: bold;
            color: #000;
            text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white;
        }
    </style>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
</head>
<body>
    <div class="container">
        <h1>Hwange-Matetsi-Zambezi Area - Land Use Map</h1>
        <div id="loading-indicator">Loading map data... Please wait.</div>
        <div id="landuse-map"></div>
        <div id="map-info">
            <p>This map displays land use categories in the Hwange-Matetsi-Zambezi area with the following color scheme:</p>
            <ul>
                <li><span class="color-box national-park"></span> National Parks</li>
                <li><span class="color-box forest"></span> Forest/State Forest</li>
                <li><span class="color-box safari"></span> Safari Areas/Matetsi Units</li>
                <li><span class="color-box community"></span> Community Conservation Areas</li>
                <li><span class="color-box resettlement"></span> Resettlement Areas</li>
            </ul>
        </div>
    </div>
    
    <!-- Custom JavaScript -->
    <script>
        // Simple debug function to log messages to console
        function debug(message) {
            console.log(`HMZ-LandUse: ${message}`);
        }
        
        // Set up configuration 
        const CONFIG = {
            mapCenter: [-18.5, 26], // Hwange-Matetsi-Zambezi area
            defaultZoom: 8,
            maxZoom: 18,
            minZoom: 5
        };
        
        // Store layers
        const allLayers = {};
        const overlayLayers = {};
        
        // Initialize the map when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            debug("Document ready, initializing map...");
            initializeLandUseMap();
        });
        
        // Initialize the map and load layers
        function initializeLandUseMap() {
            debug("Creating map...");
            
            // Create the map
            const map = L.map('landuse-map', {
                center: CONFIG.mapCenter,
                zoom: CONFIG.defaultZoom,
                maxZoom: CONFIG.maxZoom,
                minZoom: CONFIG.minZoom
            });
            // Store map globally for access in other functions
            window.map = map;
            
            debug("Map created successfully");
            
            // Add base layers
            debug("Setting up basemap layers...");
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });
            
            const baseLayers = {
                "OpenStreetMap": osm,
                "Satellite": satellite
            };
            
            // Load GeoJSON layers
            debug("Loading GeoJSON layers...");
            Promise.all([
                loadLandUseLayer(map),
                loadCommunityCALayer(map),
                loadMatetsiUnitsLayer(map),
                loadLandscapeBoundaryLayer(map),
                loadDistrictBoundariesLayer(map),
                loadRiversLayer(map),
                loadRoadsLayer(map),
                // loadTownsLayer(map), // Removed towns layer
                loadPlacesLayer(map)
            ])
            .then(() => {
                debug("All layers loaded successfully");
                createLegend(map);
                
                // Set up layer control with overlays
                L.control.layers(baseLayers, overlayLayers, {
                    collapsed: false
                }).addTo(map);
                
                // Hide loading indicator
                document.getElementById('loading-indicator').style.display = 'none';
            })
            .catch(error => {
                console.error("Error loading layers:", error);
                document.getElementById('loading-indicator').innerHTML = 
                    `Error loading map data: ${error.message}. Check console for details.`;
                document.getElementById('loading-indicator').style.color = 'red';
            });
            
            // Add scale
            L.control.scale({
                imperial: false,
                metric: true,
                position: 'bottomleft'
            }).addTo(map);
        }
        
        // Function to load the land use layer
        function loadLandUseLayer(map) {
            return new Promise((resolve, reject) => {
                fetch('data/landuse.geojson')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        debug("Land use data loaded successfully");
                        
                        // Add GeoJSON to map with styling and interactivity
                        allLayers.landUse = L.geoJSON(data, {
                            style: styleLandUse,
                            onEachFeature: onEachFeature
                        }).addTo(map);
                        
                        // Add to overlay control
                        overlayLayers["Land Use"] = allLayers.landUse;
                        
                        // Fit the map to the bounds of the GeoJSON layer
                        map.fitBounds(allLayers.landUse.getBounds());
                        
                        resolve();
                    })
                    .catch(error => {
                        console.error("Error loading land use data:", error);
                        resolve(); // Still resolve to allow other layers to load
                    });
            });
        }
        
        // Function to load the Community CA layer
        function loadCommunityCALayer(map) {
            return new Promise((resolve, reject) => {
                fetch('data/communityCA.geojson')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        debug("Community CA data loaded successfully");
                        
                        // Add GeoJSON to map with styling and interactivity
                        allLayers.communityCA = L.geoJSON(data, {
                            style: {
                                fillColor: '#8B4513', // Dark brown for Community CA
                                weight: 1,
                                opacity: 1,
                                color: '#666',
                                dashArray: '',
                                fillOpacity: 0.6
                            },
                            onEachFeature: onEachFeature
                        }).addTo(map);
                        
                        // Add to overlay control
                        overlayLayers["Community Conservation Areas"] = allLayers.communityCA;
                        
                        resolve();
                    })
                    .catch(error => {
                        console.error("Error loading Community CA data:", error);
                        resolve(); // Still resolve to allow other layers to load
                    });
            });
        }
        
        // Function to load the Matetsi Units layer
        function loadMatetsiUnitsLayer(map) {
            return new Promise((resolve, reject) => {
                fetch('data/matetsiunits.geojson')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        debug("Matetsi Units data loaded successfully");
                        
                        // Add GeoJSON to map with styling and interactivity
                        allLayers.matetsiUnits = L.geoJSON(data, {
                            style: {
                                fillColor: '#F5DEB3', // Beige for Safari Areas
                                weight: 1,
                                opacity: 1,
                                color: '#666',
                                dashArray: '',
                                fillOpacity: 0.6
                            },
                            onEachFeature: onEachFeature
                        }).addTo(map);
                        
                        // Add to overlay control
                        overlayLayers["Matetsi Units"] = allLayers.matetsiUnits;
                        
                        resolve();
                    })
                    .catch(error => {
                        console.error("Error loading Matetsi Units data:", error);
                        resolve(); // Still resolve to allow other layers to load
                    });
            });
        }
        
        // Function to load the Landscape Boundary layer
        function loadLandscapeBoundaryLayer(map) {
            return new Promise((resolve, reject) => {
                fetch('data/landscapeboundary.geojson')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        debug("Landscape Boundary data loaded successfully");
                        
                        // Add GeoJSON to map with styling and interactivity
                        allLayers.landscapeBoundary = L.geoJSON(data, {
                            style: {
                                color: '#FF0000', // Changed to red color
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0
                            },
                            onEachFeature: onEachFeature
                        }).addTo(map);
                        
                        // Add to overlay control
                        overlayLayers["Landscape Boundary"] = allLayers.landscapeBoundary;
                        
                        resolve();
                    })
                    .catch(error => {
                        console.error("Error loading Landscape Boundary data:", error);
                        resolve(); // Still resolve to allow other layers to load
                    });
            });
        }
        
        // Function to load the District Boundaries layer
        function loadDistrictBoundariesLayer(map) {
            return new Promise((resolve, reject) => {
                fetch('data/Districtboundaries.geojson')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        debug("District Boundaries data loaded successfully");
                        
                        // Add GeoJSON to map with styling and interactivity
                        allLayers.districtBoundaries = L.geoJSON(data, {
                            style: {
                                color: '#666',
                                weight: 1.5,
                                opacity: 0.8,
                                fillOpacity: 0,
                                dashArray: '5, 5'
                            },
                            onEachFeature: onEachFeature
                        });
                        
                        // Add to overlay control but don't add to map by default
                        overlayLayers["District Boundaries"] = allLayers.districtBoundaries;
                        
                        resolve();
                    })
                    .catch(error => {
                        console.error("Error loading District Boundaries data:", error);
                        resolve(); // Still resolve to allow other layers to load
                    });
            });
        }
        
        // Function to load the Rivers layer
        function loadRiversLayer(map) {
            return new Promise((resolve, reject) => {
                fetch('data/rivers.geojson')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        debug("Rivers data loaded successfully");
                        
                        // Add GeoJSON to map with styling and interactivity
                        allLayers.rivers = L.geoJSON(data, {
                            style: {
                                color: '#0000FF',
                                weight: 1.5,
                                opacity: 0.6 // Changed from 0.8 to 0.6 (60%)
                            },
                            onEachFeature: onEachFeature
                        });
                        
                        // Add to overlay control but don't add to map by default
                        overlayLayers["Rivers"] = allLayers.rivers;
                        
                        resolve();
                    })
                    .catch(error => {
                        console.error("Error loading Rivers data:", error);
                        resolve(); // Still resolve to allow other layers to load
                    });
            });
        }
        
        // Function to load the Roads layer
        function loadRoadsLayer(map) {
            return new Promise((resolve, reject) => {
                fetch('data/roads.geojson')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        debug("Roads data loaded successfully");
                        
                        // Add GeoJSON to map with styling and interactivity
                        allLayers.roads = L.geoJSON(data, {
                            style: {
                                color: '#8B4513',
                                weight: 1.5,
                                opacity: 0.6 // Changed from 0.8 to 0.6 (60%)
                            },
                            onEachFeature: onEachFeature
                        });
                        
                        // Add to overlay control but don't add to map by default
                        overlayLayers["Roads"] = allLayers.roads;
                        
                        resolve();
                    })
                    .catch(error => {
                        console.error("Error loading Roads data:", error);
                        resolve(); // Still resolve to allow other layers to load
                    });
            });
        }
        
        // Function to load the Places layer
        function loadPlacesLayer(map) {
            return new Promise((resolve, reject) => {
                fetch('data/places.geojson')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        debug("Places data loaded successfully");
                        
                        // Add GeoJSON to map with point markers
                        allLayers.places = L.geoJSON(data, {
                            pointToLayer: function(feature, latlng) {
                                return L.circleMarker(latlng, {
                                    radius: 2, // Changed from 1 to 2
                                    fillColor: "#FFA500",
                                    color: "#000",
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                });
                            },
                            onEachFeature: function(feature, layer) {
                                // Create popup
                                if (feature.properties) {
                                    let popupContent = '<div class="popup-content">';
                                    
                                    for (const prop in feature.properties) {
                                        const value = feature.properties[prop];
                                        if (value !== null && value !== undefined && value !== '') {
                                            popupContent += `<strong>${prop}:</strong> ${value}<br>`;
                                        }
                                    }
                                    
                                    popupContent += '</div>';
                                    layer.bindPopup(popupContent);
                                    
                                    // Add label for places
                                    let name = feature.properties.name || feature.properties.Name || 
                                              feature.properties.NAME || feature.properties.title || 
                                              feature.properties.TITLE || '';
                                    if (name) {
                                        layer.bindTooltip(name, {
                                            permanent: true,
                                            direction: 'right',
                                            className: 'place-label'
                                        });
                                    }
                                }
                                
                                // Only add click handler for zooming
                                layer.on({
                                    click: zoomToFeature
                                });
                            }
                        });
                        
                        // Add to overlay control but don't add to map by default
                        overlayLayers["Places"] = allLayers.places;
                        
                        resolve();
                    })
                    .catch(error => {
                        console.error("Error loading Places data:", error);
                        resolve(); // Still resolve to allow other layers to load
                    });
            });
        }
        
        // Function to determine color based on the designation
        function getColor(designation) {
            // Default color for Unknown/Resettlement Areas is brown
            let color = '#A52A2A'; // Brown for "Resettlement Area/Unknown"
            
            // If no designation provided, return brown (default)
            if (!designation) return color;
            
            // Convert designation to lowercase for case-insensitive comparison
            const desig = String(designation).toLowerCase();
            
            // Assign colors based on designation types
            if (desig.includes('national park') || desig.includes('np') || desig.includes('park')) {
                color = '#90EE90'; // Light green for National Parks
            } else if (desig.includes('forest') || desig.includes('forestry') || 
                      desig.includes('state forest') || desig.includes('reserve') ||
                      desig.includes('fr ')) {
                color = '#006400'; // Dark green for Forest areas
            } else if (desig.includes('safari') || desig.includes('game') || 
                      desig.includes('hunting') || desig.includes('sa ')) {
                color = '#F5DEB3'; // Beige for Safari areas
            } else if (desig.includes('community') || desig.includes('conservancy') || 
                      desig.includes('concession') || desig.includes('ca ') ||
                      desig.includes('ct/') || desig.includes('ct')) {
                color = '#D2B48C'; // Tan/Brown for Community Conservation Areas
            }
            
            return color;
        }
        
        // Style function for land use features
        function styleLandUse(feature) {
            let designation = 'Unknown';
            
            // Check for common property names that might contain designation information
            const possibleProps = [
                'desig', 'designation', 'type', 'class', 'landuse', 'land_use', 
                'landcover', 'land_cover', 'category', 'zone'
            ];
            
            for (const prop of possibleProps) {
                if (feature.properties[prop]) {
                    designation = feature.properties[prop];
                    break;
                }
            }
            
            // Get color based on designation
            const color = getColor(designation);
            
            return {
                fillColor: color,
                weight: 1,
                opacity: 1,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.7
            };
        }
        
        // Function to add interactivity to each feature - removed hover effects
        function onEachFeature(feature, layer) {
            // Create a popup with feature information
            if (feature.properties) {
                let popupContent = '<div class="popup-content">';
                
                // Loop through all properties and add them to the popup
                for (const prop in feature.properties) {
                    const value = feature.properties[prop];
                    if (value !== null && value !== undefined && value !== '') {
                        // Skip some properties that aren't interesting for display
                        if (['shape_leng', 'shape_area', 'SHAPE_Leng', 'SHAPE_Area'].includes(prop)) continue;
                        
                        popupContent += `<strong>${prop}:</strong> ${value}<br>`;
                    }
                }
                
                // Close the popup content div
                popupContent += '</div>';
                
                // Bind popup to layer
                layer.bindPopup(popupContent);
                
                // Add label for land use
                let name = feature.properties.name || feature.properties.Name || 
                          feature.properties.NAME || feature.properties.title || 
                          feature.properties.TITLE || '';
                if (name) {
                    layer.bindTooltip(name, {
                        permanent: true,
                        direction: 'center',
                        className: 'landuse-label'
                    });
                }
            }
            
            // Only add click handler for zooming, no mouseover effects
            layer.on({
                click: zoomToFeature
            });
        }
        
        // Zoom to feature function
        function zoomToFeature(e) {
            window.map.fitBounds(e.target.getBounds());
        }
        
        // Create a legend for the map
        function createLegend(map) {
            const legend = L.control({ position: 'bottomright' });
            
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'info legend');
                const categories = [
                    { name: 'National Park', color: '#90EE90' },
                    { name: 'Forest/State Forest', color: '#006400' },
                    { name: 'Safari Area/Matetsi Units', color: '#F5DEB3' },
                    { name: 'Community Conservation', color: '#8B4513' },
                    { name: 'Resettlement Area', color: '#A52A2A' }
                ];
                
                div.innerHTML = '<h4>Land Designation</h4>';
                
                // Generate a label with a colored square for each category
                for (let i = 0; i < categories.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + categories[i].color + '"></i> ' +
                        categories[i].name + '<br>';
                }
                
                return div;
            };
            
            legend.addTo(map);
        }
    </script>
</body>
</html>